---
import '../styles/gallery.css';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Stilllight - Photo Gallery</title>
    <meta name="description" content="A minimal photo gallery showcasing moments and memories through photography." />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://sushantn16.github.io/Stilllight/" />
    <meta property="og:title" content="Stilllight - Photo Gallery" />
    <meta property="og:description" content="A minimal photo gallery showcasing moments and memories through photography." />
    <meta property="og:image" content="https://pub-a92fe7c6ece0458c914ad88d5101a063.r2.dev/full/1df73db8-816c-4faa-a63a-ce6e151120bc_1_105_c.jpg" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://sushantn16.github.io/Stilllight/" />
    <meta property="twitter:title" content="Stilllight - Photo Gallery" />
    <meta property="twitter:description" content="A minimal photo gallery showcasing moments and memories through photography." />
    <meta property="twitter:image" content="https://pub-a92fe7c6ece0458c914ad88d5101a063.r2.dev/full/1df73db8-816c-4faa-a63a-ce6e151120bc_1_105_c.jpg" />

    <!-- Performance: Preconnect to R2 CDN for faster image loading -->
    <link rel="preconnect" href="https://pub-a92fe7c6ece0458c914ad88d5101a063.r2.dev" crossorigin />
    <link rel="dns-prefetch" href="https://pub-a92fe7c6ece0458c914ad88d5101a063.r2.dev" />

<!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "cbc08d848343432091433a18b2ea4a8a"}'></script><!-- End Cloudflare Web Analytics -->
  </head>
  <body>
    <header>
      <div class="header-content">
        <div class="header-text">
          <h1>Stilllight</h1>
          <p>Capturing moments, preserving memories</p>
        </div>
      </div>
    </header>

    <div class="photo-count" id="photo-count" role="status" aria-live="polite"></div>

    <main id="app" aria-busy="true">
      <div class="loader" id="loader" role="status" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <p>Loading photos...</p>
      </div>
      <div class="grid" id="grid" role="list"></div>
      <p class="empty" id="empty" role="status">No photos yet.</p>
    </main>

    <dialog id="dlg" aria-modal="true" aria-labelledby="dlg-title">
      <div class="dlg-controls">
        <button class="dlg-btn" id="close-btn" aria-label="Close lightbox">✕</button>
      </div>
      <div class="lb">
        <div class="lb-content">
          <div class="lb-image-container">
            <button class="nav-btn nav-prev" id="prev-btn" aria-label="Previous photo">‹</button>
            <img id="dlg-img" alt="" />
            <button class="nav-btn nav-next" id="next-btn" aria-label="Next photo">›</button>
          </div>
          <div class="lb-sidebar">
            <h2 class="lb-title" id="dlg-title"></h2>
            <div id="dlg-meta"></div>
          </div>
        </div>
      </div>
      <div class="sr-only" id="dlg-status" role="status" aria-live="polite" aria-atomic="true"></div>
    </dialog>

    <footer>Stilllight</footer>

    <script is:inline>
      // Configuration constants
      const MANIFEST_URL = "https://pub-a92fe7c6ece0458c914ad88d5101a063.r2.dev/manifest.json";
      const CACHE_DURATION_MS = 60000; // 1 minute cache busting
      const FOCUS_DELAY_MS = 0; // Delay before focusing close button
      const NAVIGATION_DEBOUNCE_MS = 100; // Debounce for keyboard navigation

      // Elements
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      const loader = document.getElementById('loader');
      const photoCount = document.getElementById('photo-count');
      const mainApp = document.getElementById('app');
      const dlg = document.getElementById('dlg');
      const dlgImg = document.getElementById('dlg-img');
      const dlgTitle = document.getElementById('dlg-title');
      const dlgMeta = document.getElementById('dlg-meta');
      const dlgStatus = document.getElementById('dlg-status');
      const closeBtn = document.getElementById('close-btn');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      // State
      let allItems = [];
      let currentIndex = -1;
      let lastFocusedElement = null;
      const preloadedImages = new Map();
      let navigationDebounceTimer = null;

      // Preload adjacent images for faster navigation
      function preloadImage(url) {
        if (!url || preloadedImages.has(url)) return;

        const img = new Image();
        img.src = url;
        preloadedImages.set(url, img);
      }

      function preloadAdjacentImages(index) {
        if (index > 0 && allItems[index - 1]?.full) {
          preloadImage(allItems[index - 1].full);
        }
        if (index < allItems.length - 1 && allItems[index + 1]?.full) {
          preloadImage(allItems[index + 1].full);
        }
      }

      // Parse EXIF date format (YYYY:MM:DD HH:MM:SS) to Date object
      function parseExifDate(exifDateStr) {
        if (!exifDateStr) return null;

        // Try to parse EXIF format: "YYYY:MM:DD HH:MM:SS"
        const exifMatch = exifDateStr.match(/^(\d{4}):(\d{2}):(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/);
        if (exifMatch) {
          const [, year, month, day, hour, minute, second] = exifMatch;
          return new Date(year, month - 1, day, hour, minute, second);
        }

        // Fallback to standard date parsing
        const date = new Date(exifDateStr);
        return isNaN(date.getTime()) ? null : date;
      }

      // Format EXIF data
      function formatExifValue(key, value) {
        if (!value) return null;
        if (key === 'CreateDate' && value) {
          const date = parseExifDate(value);
          if (date) {
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
          }
          return String(value).trim();
        }
        if (key === 'ExposureTime') {
          const numeric = Number(value);
          if (!Number.isNaN(numeric) && numeric > 0) {
            if (numeric >= 1) return `${numeric}s`;
            const denominator = Math.round(1 / numeric);
            if (denominator) return `1/${denominator}s`;
          }
          return `${value}s`;
        }
        if (key === 'FNumber') return `f/${value}`;
        if (key === 'ISO') return `ISO ${value}`;
        return String(value).trim();
      }

      // Render EXIF metadata
      function renderMetadata(item) {
        if (!item.exif) return '';

        // Camera Info
        const camera = [];
        if (item.exif.Make || item.exif.Model) {
          const cameraRows = [];
          if (item.exif.Make) cameraRows.push(`<div class="meta-row"><span class="meta-label">Camera</span><span class="meta-value">${escapeHtml(item.exif.Make)}</span></div>`);
          if (item.exif.Model) cameraRows.push(`<div class="meta-row"><span class="meta-label">Model</span><span class="meta-value">${escapeHtml(item.exif.Model)}</span></div>`);
          if (item.exif.LensModel) cameraRows.push(`<div class="meta-row"><span class="meta-label">Lens</span><span class="meta-value">${escapeHtml(item.exif.LensModel)}</span></div>`);
          camera.push(`<div class="meta-section"><h3>Camera</h3>${cameraRows.join('')}</div>`);
        }

        // Settings
        const settings = [];
        const settingRows = [];
        if (item.exif.ISO) settingRows.push(`<div class="meta-row"><span class="meta-label">ISO</span><span class="meta-value">${escapeHtml(formatExifValue('ISO', item.exif.ISO))}</span></div>`);
        if (item.exif.FNumber) settingRows.push(`<div class="meta-row"><span class="meta-label">Aperture</span><span class="meta-value">${escapeHtml(formatExifValue('FNumber', item.exif.FNumber))}</span></div>`);
        if (item.exif.ExposureTime) settingRows.push(`<div class="meta-row"><span class="meta-label">Shutter</span><span class="meta-value">${escapeHtml(formatExifValue('ExposureTime', item.exif.ExposureTime))}</span></div>`);
        if (settingRows.length) settings.push(`<div class="meta-section"><h3>Settings</h3>${settingRows.join('')}</div>`);

        // Date
        const dateSection = [];
        if (item.exif.CreateDate) {
          dateSection.push(`<div class="meta-section"><h3>Date</h3><div class="meta-row"><span class="meta-label">Taken</span><span class="meta-value">${escapeHtml(formatExifValue('CreateDate', item.exif.CreateDate))}</span></div></div>`);
        }

        return [...camera, ...settings, ...dateSection].join('');
      }

      function escapeHtml(value) {
        if (value == null) return '';
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function getDisplayTitle(item, includeIndex = false, index = 0) {
        const exif = item?.exif || {};
        const cameraParts = [exif.Make, exif.Model].filter(Boolean).join(' ');
        if (cameraParts) return cameraParts;
        if (exif.CreateDate) return formatExifValue('CreateDate', exif.CreateDate);
        if (includeIndex) return `Photo ${index + 1}`;
        return '';
      }

      function buildCardOverlay(item) {
        const exif = item?.exif || {};
        const lines = [];
        const camera = [exif.Make, exif.Model].filter(Boolean).join(' ');
        if (camera) lines.push(camera);

        const settings = [];
        if (exif.FNumber) settings.push(formatExifValue('FNumber', exif.FNumber));
        if (exif.ExposureTime) settings.push(formatExifValue('ExposureTime', exif.ExposureTime));
        if (exif.ISO) settings.push(formatExifValue('ISO', exif.ISO));
        if (settings.length) lines.push(settings.join(' · '));

        if (exif.CreateDate) lines.push(formatExifValue('CreateDate', exif.CreateDate));

        if (!lines.length) return '';
        return `<div class="card-overlay">${lines.map(line => `<p>${escapeHtml(line)}</p>`).join('')}</div>`;
      }

      // Render grid
      function renderGrid() {
        const items = allItems;
        grid.innerHTML = '';

        if (!items.length) {
          empty.classList.add('visible');
          empty.textContent = 'No photos yet.';
          photoCount.textContent = '';
          mainApp.setAttribute('aria-busy', 'false');
          return;
        }

        empty.classList.remove('visible');
        const countText = `${items.length} photo${items.length !== 1 ? 's' : ''}`;
        photoCount.textContent = countText;
        mainApp.setAttribute('aria-busy', 'false');

        const frag = document.createDocumentFragment();
        items.forEach((item, idx) => {
          // Skip invalid items
          if (!item || !item.thumb || !item.full) return;

          const title = getDisplayTitle(item, true, idx);
          const overlay = buildCardOverlay(item);
          const safeAlt = escapeHtml(title);
          const card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('role', 'listitem');
          card.dataset.index = idx;

          // First 6 images: eager loading + fetchpriority for first image
          // Rest: lazy loading for performance
          const isFirstImage = idx === 0;
          const isAboveFold = idx < 6;
          const loadingAttr = isAboveFold ? 'eager' : 'lazy';
          const fetchPriorityAttr = isFirstImage ? ' fetchpriority="high"' : '';
          const decodingAttr = isAboveFold ? ' decoding="async"' : '';

          card.innerHTML = `
            <img loading="${loadingAttr}"${fetchPriorityAttr}${decodingAttr} src="${escapeHtml(item.thumb)}"
                 srcset="${escapeHtml(item.thumb)} 480w, ${escapeHtml(item.full)} 1600w"
                 sizes="(max-width: 600px) 100vw, 300px"
                 alt="${safeAlt}">
            ${overlay}
          `;

          // Handle image load/error states
          const img = card.querySelector('img');
          img.addEventListener('load', () => img.classList.add('loaded'));
          img.addEventListener('error', () => {
            img.classList.add('error');
            img.alt = `${safeAlt} (failed to load)`;
          });

          frag.appendChild(card);
        });
        grid.appendChild(frag);
      }

      // Get all focusable elements in dialog
      function getFocusableElements() {
        return dlg.querySelectorAll(
          'button:not([disabled]), [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
      }

      // Trap focus inside dialog
      function trapFocus(e) {
        if (!dlg.open) return;

        const focusableElements = getFocusableElements();
        if (focusableElements.length === 0) return;

        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              e.preventDefault();
              lastElement.focus();
            }
          } else {
            if (document.activeElement === lastElement) {
              e.preventDefault();
              firstElement.focus();
            }
          }
        }
      }

      // Open lightbox
      function openLightbox(index) {
        // Bounds check
        if (index < 0 || index >= allItems.length) return;

        currentIndex = index;
        const item = allItems[currentIndex];

        dlgImg.src = item.full;
        const title = getDisplayTitle(item, true, index);
        dlgImg.alt = title;
        dlgTitle.textContent = title;
        dlgMeta.innerHTML = renderMetadata(item);

        // Update nav buttons
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === allItems.length - 1;

        // Announce to screen readers
        const position = `Photo ${currentIndex + 1} of ${allItems.length}`;
        dlgStatus.textContent = `${position}. ${title}`;

        // Store last focused element and open dialog
        lastFocusedElement = document.activeElement;
        dlg.showModal();

        // Preload adjacent images for faster navigation
        preloadAdjacentImages(index);

        // Set focus to close button after opening
        setTimeout(() => closeBtn.focus(), FOCUS_DELAY_MS);
      }

      // Close lightbox
      function closeLightbox() {
        dlg.close();
        // Restore focus to the element that opened the dialog
        if (lastFocusedElement) {
          lastFocusedElement.focus();
          lastFocusedElement = null;
        }
      }

      // Navigate lightbox
      function navigateLightbox(direction) {
        if (!allItems || allItems.length === 0) return;

        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < allItems.length) {
          openLightbox(newIndex);
        }
      }

      // Debounced navigation for keyboard
      function debouncedNavigate(direction) {
        if (navigationDebounceTimer) return;

        navigateLightbox(direction);
        navigationDebounceTimer = setTimeout(() => {
          navigationDebounceTimer = null;
        }, NAVIGATION_DEBOUNCE_MS);
      }

      // Debounced jump for Home/End keys
      function debouncedJump(index) {
        if (navigationDebounceTimer) return;

        openLightbox(index);
        navigationDebounceTimer = setTimeout(() => {
          navigationDebounceTimer = null;
        }, NAVIGATION_DEBOUNCE_MS);
      }

      // Load photos
      async function load() {
        try {
          loader.style.display = 'block';
          // Use default caching but add cache-busting timestamp for manifest updates
          const manifestUrl = `${MANIFEST_URL}?t=${Math.floor(Date.now() / CACHE_DURATION_MS)}`;
          const res = await fetch(manifestUrl);

          if (!res.ok) {
            const errorMsg = `Failed to load photos (HTTP ${res.status})`;
            throw new Error(errorMsg);
          }

          const data = await res.json();
          if (!data || !Array.isArray(data.items)) {
            throw new Error('Invalid manifest format');
          }

          allItems = data.items;

          loader.style.display = 'none';
          renderGrid();
        } catch (e) {
          loader.style.display = 'none';
          empty.classList.add('visible');

          // Provide more helpful error messages
          if (e.name === 'TypeError' && e.message.includes('fetch')) {
            empty.textContent = 'Network error. Please check your connection.';
          } else if (e.message.includes('HTTP')) {
            empty.textContent = e.message;
          } else if (e.message.includes('Invalid manifest')) {
            empty.textContent = 'Photo data is corrupted. Please try again later.';
          } else {
            empty.textContent = 'Could not load photos. Please try again.';
          }

          console.error('Photo loading error:', e);
        }
      }

      // Event listeners
      grid.addEventListener('click', e => {
        const card = e.target.closest('.card');
        if (!card) return;
        const index = parseInt(card.dataset.index, 10);
        if (!isNaN(index)) {
          openLightbox(index);
        }
      });

      closeBtn.addEventListener('click', closeLightbox);
      prevBtn.addEventListener('click', () => navigateLightbox(-1));
      nextBtn.addEventListener('click', () => navigateLightbox(1));

      // Keyboard navigation and focus trap
      document.addEventListener('keydown', e => {
        if (!dlg.open) return;

        // Handle keyboard navigation
        if (e.key === 'Escape') {
          e.preventDefault();
          closeLightbox();
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          debouncedNavigate(-1);
        }
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          debouncedNavigate(1);
        }
        if (e.key === 'Home') {
          e.preventDefault();
          debouncedJump(0);
        }
        if (e.key === 'End') {
          e.preventDefault();
          debouncedJump(allItems.length - 1);
        }

        // Trap focus inside dialog
        trapFocus(e);
      });

      // Click backdrop to close
      dlg.addEventListener('click', e => {
        if (e.target === dlg) closeLightbox();
      });

      // Load on page load
      load();
    </script>
  </body>
</html>
